// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// Users - main user table (Updated for NextAuth)
model User {
  id            String    @id @default(cuid())
  email         String?   @unique
  emailVerified DateTime?
  password      String?   // Hashed password for credentials login
  name          String?
  image         String?
  
  // HSR-specific fields
  uid           String?   @unique // HSR UID (optional, set after first login)
  nickname      String?
  level         Int       @default(0)
  avatar        String?
  hasSetUid     Boolean   @default(false) // Track if user has set their UID
  
  createdAt     DateTime  @default(now())
  lastLoginAt   DateTime  @default(now())
  
  // NextAuth relations
  accounts      Account[]
  sessions      Session[]
  
  // App relations
  profile          UserProfile?
  activities       Activity[]
  teamPresets      TeamPreset[]
  pullPlans        PullPlan[]
  battleHistory    Battle[]
  ownedCharacters  UserCharacter[]
}

// NextAuth Account model (for OAuth providers)
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

// NextAuth Session model
model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// NextAuth VerificationToken (for email verification & password reset)
model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime
  type       String   @default("email") // email, password_reset, otp

  @@unique([identifier, token])
}

// Cached profile data from Mihomo API
model UserProfile {
  id          String   @id @default(cuid())
  userId      String   @unique
  user        User     @relation(fields: [userId], references: [id])
  data        Json     // Full profile JSON
  updatedAt   DateTime @updatedAt
}

// Activity log for tracking user history
model Activity {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  type      String   // login, speed_tuner, pull_planner, battle, profile_refresh
  data      Json?    // Additional data (team used, simulation results, etc)
  createdAt DateTime @default(now())
}

// Saved team presets for Speed Tuner
model TeamPreset {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  name        String
  characters  Json     // Array of character configs with speed settings
  createdAt   DateTime @default(now())
}

// Pull planner saved state
model PullPlan {
  id           String   @id @default(cuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id])
  currentPity  Int
  isGuaranteed Boolean
  stellarJade  Int
  passes       Int
  targetBanner String?
  updatedAt    DateTime @updatedAt
}

// Battle history
model Battle {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  team        Json     // Characters used
  enemy       Json     // Enemy config
  result      String   // victory, defeat, abandoned
  totalDamage Int
  turns       Int
  duration    Int?     // seconds
  createdAt   DateTime @default(now())
}

// --- Game Data Reference Models ---

model GameCharacter {
  id        String   @id // internal id, e.g. "acheron"
  charId    String   // game id, e.g. "1308"
  name      String
  rarity    Int
  path      String
  element   String
  baseSpeed Int
  
  // Relations
  skillData GameCharacterSkill?
  eidolons  Eidolon[]
  owners    UserCharacter[]
}

model GameCharacterSkill {
  id              String        @id @default(cuid())
  characterId     String        @unique
  character       GameCharacter @relation(fields: [characterId], references: [id])
  
  basicMultiplier Float
  skillMultiplier Float
  ultMultiplier   Float
  basicEnergy     Int
  skillEnergy     Int
  ultCost         Int
  ultType         String        // normal, stacks
  passive         String?
  skillSPCost     Int           @default(1)
  ultSPChange     Int           @default(0)
  
  // Buffs/Debuffs
  skillBuff       Json?
  skillDebuff     Json?
  ultBuff         Json?
  ultDebuff       Json?
  
  baseAtk         Int
  baseCritRate    Float
  baseCritDmg     Float
}

model RelicSet {
  id     String @id @default(cuid())
  gameId String? // e.g. "101"
  name   String
  type   String // Cavern / Planar
}

model Path {
  id    String @id // Destruction, Hunt, etc.
  name  String
  icon  String?
}

model Element {
  id    String @id // Physical, Fire, etc.
  name  String
  color String? // Hex code
  icon  String?
}

model Eidolon {
  id          String        @id @default(cuid())
  characterId String
  character   GameCharacter @relation(fields: [characterId], references: [id])
  rank        Int
  name        String
  desc        String
  icon        String?
}

model LightCone {
  id        String   @id // internal slug
  gameId    String?  // game id
  name      String
  rarity    Int
  path      String
  maxHp     Int      // Level 80 stat
  maxAtk    Int
  maxDef    Int
  
  superimpositions LightConeSuperimposition[]
}

model LightConeSuperimposition {
  id          String    @id @default(cuid())
  lightConeId String
  lightCone   LightCone @relation(fields: [lightConeId], references: [id])
  rank        Int       // 1-5
  desc        String
  properties  Json?
}

model Enemy {
  id           String   @id @default(cuid())
  slug         String   @unique // json id e.g. "phantylia"
  name         String
  type         String   // boss, elite
  
  maxHp        Int
  speed        Int
  defense      Int
  toughness    Int      @default(300)

  weaknesses   Json     // String[]
  resistances  Json     // Map<Element, Float>
  
  statusRes    Json?    // Map<Status, Float>
  debuffRes    Json?    // specific debuff interactions
  
  imageUrl     String?
  
  variants     Json?
}

model UserCharacter {
  id          String        @id @default(cuid())
  userId      String
  user        User          @relation(fields: [userId], references: [id])
  characterId String
  character   GameCharacter @relation(fields: [characterId], references: [id])
  
  eidolon     Int           @default(0) // E0-E6
  level       Int           @default(1)
  lightConeId String?
  
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  
  @@unique([userId, characterId])
}

// --- Lore Data Models ---

model CharacterLore {
  id            String   @id // same as GameCharacter id, e.g. "acheron"
  name          String
  title         String?
  bio           String   @db.Text
  element       String
  path          String
  factionId     String?
  faction       Faction? @relation(fields: [factionId], references: [id])
  
  // Relations
  outgoingRelations CharacterRelationship[] @relation("FromCharacter")
  incomingRelations CharacterRelationship[] @relation("ToCharacter")
  timelineEvents    TimelineCharacter[]
}

model CharacterRelationship {
  id            String        @id @default(cuid())
  fromId        String
  fromCharacter CharacterLore @relation("FromCharacter", fields: [fromId], references: [id])
  toId          String
  toCharacter   CharacterLore @relation("ToCharacter", fields: [toId], references: [id])
  
  type          String        // ally, enemy, family, friend, related, serves, complex
  label         String?       // Description like "Fellow Hunter", "Sister"
  
  @@unique([fromId, toId])
}

model Faction {
  id          String          @id // e.g. "astral_express"
  name        String
  type        String          // allies, ambiguous, neutral, location
  description String          @db.Text
  leader      String?
  color       String?         // Hex code
  icon        String?         // Emoji icon
  
  members     CharacterLore[]
}

model Location {
  id          String   @id // e.g. "jarilo_vi"
  name        String
  type        String   // space_station, planet, flagship, dreamscape
  description String   @db.Text
  areas       Json?    // String[] of area names
  
  // Connection relations
  connectionsFrom LocationConnection[] @relation("FromLocation")
  connectionsTo   LocationConnection[] @relation("ToLocation")
  
  // Timeline events at this location
  timelineEvents  TimelineEvent[]
}

model LocationConnection {
  id           String   @id @default(cuid())
  fromId       String
  fromLocation Location @relation("FromLocation", fields: [fromId], references: [id])
  toId         String
  toLocation   Location @relation("ToLocation", fields: [toId], references: [id])
  
  @@unique([fromId, toId])
}

model TimelineEvent {
  id          String   @id // e.g. "1", "2"
  title       String
  chapter     String   // "Prologue", "Chapter 1", etc.
  description String   @db.Text
  locationId  String?
  location    Location? @relation(fields: [locationId], references: [id])
  order       Int      @default(0) // Order in timeline
  
  characters  TimelineCharacter[]
}

model TimelineCharacter {
  id          String        @id @default(cuid())
  eventId     String
  event       TimelineEvent @relation(fields: [eventId], references: [id])
  characterId String
  character   CharacterLore @relation(fields: [characterId], references: [id])
  
  @@unique([eventId, characterId])
}

